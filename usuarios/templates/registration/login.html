<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio de Sesión</title>

    <script src="https://code.jquery.com/jquery-3.6.4.js" integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E=" crossorigin="anonymous"></script>

    <script>
        const synthesis = window.speechSynthesis;
        let speaking = true, escribiendo = false, dictando = false;
        const voice = synthesis.getVoices().filter(function (voice) {
            return voice.lang === 'es';
        })[2];
        const comandos = {
            "ayuda": "Indica todos los comandos con su descripción.",
            "iniciar sesión": "Da inicio al formulario de inicio de sesión",
            "crear nuevo usuario": "Lleva a la pantalla de nuevo usuario",
            "soy ciego": "Lleva al inicio de sesión exclusivo para personas con discapacidad visual"
        };

        function formulario_p1(event){
            for (var i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal){
                   speech = event.results[i][0].transcript;
                   console.log(speech);
                    ["dictado", "teclado", "salir", "JAMMU", "continuar", "editar", "listo"].forEach(comando => {
                      if(!speaking && speech.toLowerCase().includes(comando)){
                        console.log(comando);
                        switch (comando) {
                            case "salir":
                                hablar("Usted ha dicho salir. Saliendo del formulario.");
                                recognition.onresult = inicial;
                            break;

                            case "dictado":
                                hablar("Usted ha dicho dictado. Deletree o dicte con claridad su correo electrónico.");
                                escribiendo = true;
                                dictando = true;
                                break;
                            
                            case "JAMMU":
                                hablar("Jammu es la Diosa Planta.");
                                break;

                            case "teclado":
                                hablar("Usted ha dicho teclado. Escriba su correo electrónico y presione la tecla enter o tabulador, o diga 'listo'.");
                                escribiendo = true;
                                const input = document.getElementById('id_username');
                                input.focus();
                                break;

                            case "continuar":
                                if(!escribiendo){
                                    const input2 = document.getElementById('id_password');
                                    inputx.focus();   
                                    hablar("Campo #2: Contraseña. Por razones de seguridad, las contraseñas solo pueden ingresarse por teclado.")
                                }
                                break;
                            
                            case "editar":
                                break;

                            case "listo":
                                hablar("Usted ha escrito: " + $('#id_username').val() + " Diga 'editar' para editar o 'continuar' para seguir con el siguiente campo.")
                                escribiendo = false;
                                dictando = false;
                                break;
                            }
                        }
                    });

                    if(dictando){
                        console.log(speech);
                        console.log($('#id_username').val());
                        $('#id_username').val( $('#id_username').val() + speech.toLowerCase().replace('arroba', '@').replace(" ", "").replace(".","").replace("punto", "."));
                    }  
                }
            }
        }

        function inicial(event) {
            for (var i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal){
                   speech = event.results[i][0].transcript;
                   console.log(speech);
                   Object.keys(comandos).forEach(comando => {
                      if(!speaking && speech.toLowerCase().includes(comando)){
                        console.log(comando);
                        switch (comando) {
                            case "ayuda":
                                if ('speechSynthesis' in window) {
                                    const crear_utterance = () => {
                                        let x = "";
                                        Object.keys(comandos).forEach((comando) => x += "Comando " + comando + ": " + comandos[comando] + "..........");
                                        return x;
                                    };        
                                    
                                    hablar("Usted ha dicho ayuda. " + crear_utterance());
                                }
                            break;

                            case "iniciar sesión":
                                hablar("Usted ha dicho iniciar sesión. Diga 'salir' para salir del formulario. Formulario:");
                                hablar("Campo #1: Correo Electrónico. Si desea escribirlo en teclado, diga 'teclado'. Si desea dictar su correo electrónico, diga 'dictado'. Si desea salir, diga 'salir'.");
                                
                                recognition.onresult = formulario_p1;
                                
                                break;
                            
                            case "crear nuevo usuario":
                                hablar("Usted ha dicho crear nuevo usuario. Redirigiendo.");
                                location.replace("/usuarios/register");
                                break;
                            
                            case "soy ciego":
                                hablar("Usted ha dicho soy ciego. Redirigiendo.");
                                location.replace("/usuarios/register");
                                break;
                        }
                      }    
                   });
                }
            }
        }

        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
        var recognition = new SpeechRecognition();
        recognition.lang = "es-VE";
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = inicial;

        recognition.onerror = (event) => {
            console.log(event);
        }

        async function bienvenida(){
            if ('speechSynthesis' in window) {
                var utterance = new SpeechSynthesisUtterance('Justo ahora está en la pantalla de inicio de sesión general. Si quiere saber los comandos disponibles diga "ayuda".');
                utterance.voice = voice;
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;
                utterance.onend = () => {speaking = false};
                synthesis.speak(utterance);
                recognition.start();
                recognition.addEventListener('end', recognition.start);
            }
        }

        async function hablar(texto){
            if ('speechSynthesis' in window) {
                speaking = true;
                var utterance = new SpeechSynthesisUtterance(texto);
                utterance.voice = voice;
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;
                utterance.onend = () => {speaking = false};
                synthesis.speak(utterance);
            }
        }

        bienvenida();

        $('#id_username').blur(() => {
            if(escribiendo){
                const input = document.getElementById('id_username');
                console.log(input);
                input.focus();
            }
        });
    </script>
</head>
<body>
    <h1>Inicio de Sesión</h1>
<form action="{% url 'bienvenida' %}" method="post">
    {% csrf_token %}
    {{form.as_p}}
    <input type="submit" value="Enviar">
    <a href="{% url 'registro' %}">Crear Nuevo Usuario</a>
    <a href="#">Soy ciego y uso otro método de autenticación</a>
</form>    
</body>
</html>