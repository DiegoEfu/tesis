<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenida</title>

    <script>
        const synthesis = window.speechSynthesis;
        let speaking = true, escribiendo = false, dictando = false, campo = 0;
        const voice = synthesis.getVoices().filter(function (voice) {
            return voice.lang === 'es';
        })[2];
        
        const comandos = {
            "ayuda": "Indica todos los comandos con su descripción.",
            // {% if not request.user.is_authenticated %}
            "iniciar sesión": "Lleva a la pantalla de inicio de sesión.",
            // {% else %}
            "cerrar sesión": "Cierra la sesión actual",
            // {% endif %}
            "buscar inmueble": "Permitirá buscar un inmueble."
        };

        function inicial(event) {
            for (var i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal){
                   speech = event.results[i][0].transcript;
                   console.log(speech);
                   ["ayuda","iniciar sesión","buscar inmueble", "cerrar sesión", "dictado", "salir", "listo",
                    "continuar", "editar"].forEach(comando => {
                      if(!speaking && speech.toLowerCase().includes(comando)){
                        console.log(comando);
                        switch (comando) {
                            case "ayuda":
                                if ('speechSynthesis' in window) {
                                    const crear_utterance = () => {
                                        let x = "";
                                        Object.keys(comandos).forEach((comando) => x += "Comando " + comando + ": " + comandos[comando] + "..........");
                                        return x;
                                    };        
                                    
                                    hablar("Usted ha dicho ayuda. " + crear_utterance());
                                }
                                break;

                            case "iniciar sesión":
                                hablar("Redirigiendo a la pantalla de inicio de sesión.");
                                location.replace("/usuarios/login/");
                                
                                break;
                            
                            case "buscar inmueble":
                                hablar("Escriba la descripción del inmueble que desea. Diga dictado para dictarla. Diga salir para no buscar. Diga listo una vez haya finalizado.");
                                const input = document.getElementById('busqueda');
                                input.focus();
                                campo = 1;

                                break;

                            case "dictado":
                                if(campo === 1){
                                    hablar("Deletree o dicte la descripción del inmueble que busca");
                                    dictando = true;
                                }
                                
                                break;
                            
                            case "salir":
                                if(campo === 1){
                                    hablar("Saliendo del formulario.");
                                    dictando = false;
                                    campo = 0;
                                }
                                break;

                            case "listo":
                                hablar(`Usted ha escrito: ${document.getElementById('busqueda')}. Diga "continuar" para buscar inmuebles, o diga "editar" para editar.`);
                                campo = 2;
                                dictando = false;
                                break;
                            
                            case "continuar":
                                if(campo === 2)
                                    document.getElementById('form_busqueda').submit();
                                break;
                            
                            case "editar":
                                if(campo === 2){
                                    campo = 1;
                                    document.getElementById('busqueda').value = "";
                                    document.getElementById('busqueda').focus();
                                }
                                break;
                        }
                      }    
                   });

                   if(dictando && speech.indexOf("dictado") == -1)
                        document.getElementById('busqueda').value += " " + speech.toLowerCase().slice(0,-1);
                }
            }
        }

        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
        var recognition = new SpeechRecognition();
        recognition.lang = "es-VE";
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = inicial;

        recognition.onerror = (event) => {
            if(event.error !== 'no-speech'){
                console.log(event);
            }
        }

        function bienvenida(){
            if ('speechSynthesis' in window) {
                let utterance = new SpeechSynthesisUtterance('{% if request.user.is_aunthenticated %}Bienvenido, {{request.user.persona.nombre}}. {% endif %}' + 'Justo ahora está en la pantalla de bienvenida.' 
                    + ' Si quiere saber los comandos disponibles diga "ayuda".');
                
                utterance.voice = voice;
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;
                utterance.onend = () => {speaking = false};
                synthesis.speak(utterance);
                recognition.start();
                recognition.addEventListener('end', recognition.start);
            }
        }

        function hablar(texto){
            if ('speechSynthesis' in window) {
                speaking = true;
                var utterance = new SpeechSynthesisUtterance(texto);
                utterance.voice = voice;
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;
                utterance.onend = () => {speaking = false};
                synthesis.speak(utterance);
            }
        }
        
        bienvenida();
    </script>
</head>
<body>
    {% if request.user.is_authenticated %}
    <form method='POST' action="">
        {% csrf_token %}
        <button>SALIR</button>
    </form>
    {% endif %}

    <div>
        <form method="post" id="form_busqueda">
            {% csrf_token %}
            <input type="hidden" name="formulario" value="busqueda">
            <h3>Busca tu nuevo hogar...</h3>
            <input type="text" name="busqueda" id="busqueda" maxlength="120" placeholder="Escribe aquí tu búsqueda...">
            <input type="submit">
        </form>
    </div>

    <div>
        <!--
            Información General
        -->
    </div>

    <div>
        <!--
            Accesibilidad
        -->
    </div>

    <div>
        <!--
            Agentes Calificados
        -->
    </div>

    <div>
        <!--
           Invitación a Registro
        -->
    </div>

    <footer>
        <!--
           Footer
        -->        
    </footer>
</body>
</html>