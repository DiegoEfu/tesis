<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cita Creada para {{cita.inmueble.nombre}}</title>

    <script>
        const synthesis = window.speechSynthesis;
        let speaking = true, escribiendo = false, dictando = false, campo = 0;
        const voice = synthesis.getVoices().filter(function (voice) {
            return voice.lang === 'es';
        })[2];
        
        const comandos = {
            "ayuda": "Indica todos los comandos con su descripción.",
            "leer pantalla": "Lee el contenido de la pantalla",
            "leer detalles": "Lee los detalles de la cita agendada",
            "descargar pdf": "Descarga el comprobante de cita en formato PDF",
            "descargar mp3": "Descarga el comprobante de cita en formato MP3",
            // {% if not request.user.is_authenticated %}
            "iniciar sesión": "Lleva a la pantalla de inicio de sesión.",
            // {% else %}
            "cerrar sesión": "Cierra la sesión actual",
            "consultar compras": "Permite consultar las compras realizadas por su persona",
            "consultar ventas": "Permite consultar las ventas de sus publicaciones",
            "consultar citas": "Permite consultar las citas que ha solicitado",
            "consultar publicaciones": "Permite consultar las publicaciones de sus inmuebles",
            // {% endif %}
            
        };

        function inicial(event) {
            for (var i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal){
                   speech = event.results[i][0].transcript.replace(/[,.]/g,'').replace("cuatro", "4");
                   console.log(speech);
                   ["ayuda","iniciar sesión","consultar compras","consultar ventas","consultar citas","consultar publicaciones",
                   "regresar inicio", "cerrar sesión", "leer pantalla", "leer detalles", "descargar pdf", "descargar mp 3", "salir"].forEach(comando => {
                      if(!speaking && speech.toLowerCase().includes(comando)){
                        console.log(comando);
                        switch (comando) {
                            case "ayuda":
                                if ('speechSynthesis' in window) {
                                    const crear_utterance = () => {
                                        let x = "";
                                        Object.keys(comandos).forEach((comando) => x += "Comando " + comando + ": " + comandos[comando] + "..........");
                                        return x;
                                    };        
                                    
                                    hablar("Usted ha dicho ayuda. Esta es la pantalla de cita agendada exitosamente. " + crear_utterance());
                                }
                                break;
                            
                            case "consultar compras":
                                hablar("Redirigiendo a la pantalla de compras.");
                                location.replace("/inmuebles/consultar/compras/");
                                break;

                            case "consultar ventas":
                                hablar("Redirigiendo a la pantalla de ventas.");
                                location.replace("/inmuebles/consultar/ventas/");
                                break;

                            case "consultar citas":
                                hablar("Redirigiendo a la pantalla de citas.");
                                location.replace("/inmuebles/consultar/citas/");
                                break;
                            
                            case "consultar publicaciones":
                                hablar("Redirigiendo a la pantalla de publicaciones.");
                                location.replace("/inmuebles/consultar/publicaciones/");
                                break;
                                                        
                            case "leer pantalla":
                                hablar(`Esta es la pantalla de detalle de cita agendada. La pantalla está dividida en las siguientes secciones:
                                    1. Barra de Navegación: Aquí se encuentran las opciones de navegación básicas.
                                    2. Sección de Detalles: Aquí se muestran los detalles de la cita especificada. Diga "leer detalles" para escucharlos.
                                    3. Sección de Reportes: Aquí se encuentran los botones para la descarga del comprobante de cita. Diga "descargar pdf", o, "descargar mp3" para descargarlo ya que deberá llevarlo a la cita.
                                `);
                                break;
                            
                            case "leer detalles":
                                hablar(`
                                Su cita ha sido agendada exitosamente. Estos son los datos de la cita agendada:
                                    Sector:{{cita.inmueble.sector.nombre}}.
                                    Dirección:{{cita.inmueble.ubicacion_detallada}}.
                                    Fecha y Hora:{{cita.fecha_asignada}}.
                                    Nombre del Agente:{{cita.inmueble.agente}}.
                                    Teléfono del Agente:{{cita.inmueble.agente.numero_telefono}}.
                                    Correo del Agente:{{cita.inmueble.agente.usuario_persona.email}}.
                                `)
                                break;
                            
                            case "descargar pdf":
                                document.getElementById('pdf').click();
                                hablar("Descargando comprobante PDF.");
                                break;

                            case "descargar mp 3":
                                document.getElementById('mp3').click();
                                hablar("Descargando comprobante MP3.");
                                break;

                            case "regresar inicio":
                                window.location.replace("/");
                                break;
                        }
                      }    
                   });
                }
            }
        }

        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
        var recognition = new SpeechRecognition();
        recognition.lang = "es-VE";
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = inicial;

        recognition.onerror = (event) => {
            if(event.error !== 'no-speech'){
                console.log(event);
            }
        }

        function bienvenida(){
            if ('speechSynthesis' in window) {
                let utterance = new SpeechSynthesisUtterance(`
                Su cita ha sido agendada exitosamente. Estos son los datos de la cita agendada:
                    Sector:{{cita.inmueble.sector.nombre}}.
                    Dirección:{{cita.inmueble.ubicacion_detallada}}.
                    Fecha y Hora:{{cita.fecha_asignada}}.
                    Nombre del Agente:{{cita.inmueble.agente}}.
                    Teléfono del Agente:{{cita.inmueble.agente.numero_telefono}}.
                    Correo del Agente:{{cita.inmueble.agente.usuario_persona.email}}.
                Diga "leer detalles" para escuchar de nuevo los detalles. Diga "descargar pdf" o "descargar mp3" para descargar el comprobante de cita en el formato especificado, el cual debe llevar a la cita.
                `);
                
                utterance.voice = voice;
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;
                utterance.onend = async (evt) => {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    speaking = false;
                    console.log("LISTO");
                };
                synthesis.speak(utterance);
                recognition.start();
                recognition.addEventListener('end', recognition.start);
            }
        }

        function hablar(texto){
            if ('speechSynthesis' in window) {
                speaking = true;
                var utterance = new SpeechSynthesisUtterance(texto);
                utterance.voice = voice;
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;
                utterance.onend = async (evt) => {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    speaking = false;
                    console.log("LISTO");
                };
                synthesis.speak(utterance);
            }
        }
        
        bienvenida();
    </script>
</head>

<body>
    <a href="/">Regresar</a>
    <h2>¡Cita Agendada Exitosamente!</h2>
    Estos son los datos de la cita:
    <ul>
        <li><b>Sector: </b>{{cita.inmueble.sector.nombre}}.</li>
        <li><b>Dirección: </b>{{cita.inmueble.ubicacion_detallada}}.</li>
        <li><b>Fecha y Hora: </b>{{cita.fecha_asignada}}.</li>
        <li><b>Nombre del Agente: </b>{{cita.inmueble.agente}}.</li>
        <li><b>Teléfono del Agente: </b>{{cita.inmueble.agente.numero_telefono}}.</li>
        <li><b>Correo del Agente: </b>{{cita.inmueble.agente.usuario_persona.email}}.</li>
    </ul>

    Puedes descargar el comprobante presionando el siguiente botón (debe llevarlo en formato digital o físico a la cita):
    <form method="post">
        {% csrf_token %}
        <button id="pdf" name="tipo" value="pdf" type="submit">Descargar Comprobante PDF</button>
        <button id="mp3" name="tipo" value="mp3" type="submit">Descargar Comprobante MP3</button>
    </form>
</body>
</html>