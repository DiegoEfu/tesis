<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Pagos</title>

    <script>
        const synthesis = window.speechSynthesis;
        let speaking = false, escribiendo = false, dictando = false, reporte = false, campo = 0;
        const voice = synthesis.getVoices().filter(function (voice) {
            return voice.lang === 'es';
        })[2];
        
        const comandos = {
            "ayuda": "Indica todos los comandos con su descripción.",
            "leer pantalla": "Lee el contenido de la pantalla",
            "registrar nuevo pago": "Lleva al formulario de registro de pago",
            "desactivar comandos de voz": "Desactiva los comandos de voz",
            // {% if pagos.count %}
            "leer pago": "Seguido de un número lee los detalles del pago especificado.",
            "descargar pdf": "Descarga el reporte PDF de la compra",
            "descargar mp3": "Descarga el reporte MP3 de la compra",
            //{% endif %}
            "cerrar sesión": "Cierra la sesión actual",
            "consultar compras": "Permite consultar las compras realizadas por su persona",
            "consultar ventas": "Permite consultar las ventas de sus publicaciones",
            "consultar citas": "Permite consultar las citas que ha solicitado",
            "consultar publicaciones": "Permite consultar las publicaciones de sus inmuebles",
            "ver perfil": "Permite ver sus datos personales",  s
        };

        function inicial(event) {
            for (var i = event.resultIndex; i < event.results.length && !speaking; i++) {
                if (event.results[i].isFinal){
                   speech = event.results[i][0].transcript.replace(/[,.]/g,'').toLowerCase().replace("dos","2").replace("tres","3").replace("cuatro","4")
                                .replace("cinco","5").replace("seis","6").replace("siete","7").replace("ocho","8")
                                .replace("nueve","9").replace("uno","1").replace("una","1").replace(/[rR]egresar\sa[l]*\sinicio/g, "regresar inicio");;
                   console.log(speech);

                   if(localStorage.getItem('comandos') == '1')
                   ["ayuda","ver perfil","consultar compras","consultar ventas","consultar citas","consultar publicaciones",
                   "descargar mp3", "descargar mp 3", "registrar nuevo pago", "descargar pdf","cerrar sesión", "leer pantalla", "leer pago", "regresar inicio",
                   "desactivar comandos de voz"].forEach(comando => {
                      if(!speaking && speech.toLowerCase().includes(comando)){
                        console.log(comando);
                        switch (comando) {
                            case "desactivar comandos de voz":
                                localStorage.setItem('comandos', 0);
                                hablar("Se han desactivado los comandos de voz. Diga 'activar comandos de voz' para activarlos de nuevo'");
                                break;

                            case "regresar inicio":
                                window.location.replace("/");
                                break;
                                
                            case "ayuda":
                                if ('speechSynthesis' in window) {
                                    const crear_utterance = () => {
                                        let x = "";
                                        Object.keys(comandos).forEach((comando) => x += "Comando " + comando + ": " + comandos[comando] + "..........");
                                        return x;
                                    };        
                                    
                                    hablar("Usted ha dicho ayuda. " + crear_utterance());
                                }
                                break;
                            
                            // {% if request.user.is_authenticated %}
                            case "consultar compras":
                                hablar("Redirigiendo a la pantalla de compras.");
                                location.replace("/inmuebles/consultar/compras/");
                                break;

                            case "consultar ventas":
                                hablar("Redirigiendo a la pantalla de ventas.");
                                location.replace("/inmuebles/consultar/ventas/");
                                break;

                            case "consultar citas":
                                hablar("Redirigiendo a la pantalla de citas.");
                                location.replace("/inmuebles/consultar/citas/");
                                break;
                            
                            case "consultar publicaciones":
                                hablar("Redirigiendo a la pantalla de publicaciones.");
                                location.replace("/inmuebles/consultar/publicaciones/");
                                break;

                            case "cerrar sesión":
                                document.getElementById('cerrar_sesion').click();
                                break;

                            case "ver perfil":
                                window.location.replace('/usuarios/perfil/');
                                break;
                            // {%endif%}
                                                        
                            case "leer pantalla":
                                hablar(`Esta es la pantalla de consultas de pagos de sus compras. Usted ha realizado {{compras.count}} compras. La pantalla está dividida en las siguientes secciones:
                                    1. Barra de Navegación: Aquí se encuentran las opciones de navegación básicas.
                                    2. Sección de Reportes: Aquí se muestran las opciones de reportes tanto en formato PDF como MP3.
                                    3. Sección de pagos: Aquí se muestra la lista de pagos realizadas por su persona, diga "leer pago" seguido del número de pago para escuchar la información.
                                `);
                                break;
                            
                            case "leer pago":
                                const numero = speech.split(" ")[speech.split(" ").indexOf("pago") + 1].replace(/[.,]/g,"")
                                .replace("dos","2").replace("tres","3").replace("cuatro","4")
                                .replace("cinco","5").replace("seis","6").replace("siete","7").replace("ocho","8")
                                .replace("nueve","9").replace("uno","1").replace("una","1");
                                let pasado = false;
                                console.log(numero);
                                // {% for pago in pagos %}
                                if(numero == '{{forloop.counter}}'){
                                    hablar(`Este pago se realizó el día {{pago.fecha.date}}. 
                                        El monto pagado fue de bolívares {{pago.monto_texto}} los cuales fueron al cambio del día {{pago.tasa.tasa_texto}} por dólar, un valor de
                                        {{pago.valor_dolar_texto}} dólares.
                                        Se realizó por transferencia a la cuenta: {{pago.cuenta}},
                                        con una referencia número {{pago.referencia}}.
                                        Usted añadió el comentario: {{pago.comentario}}.

                                        El estado del pago es: {{pago.estado_largo}}.

                                        {% if pago.estado == 'R' %}
                                            Luego de revisión administrativa se dejó la siguiente observación para 
                                            su consideración al reportar un nuevo pago: {{pago.comentario_cajero}}.
                                        {% endif %}`)
                                    pasado = true;
                                }
                                // {% endfor %}

                                if(!pasado)
                                    hablar(`No hay compra con el número '${numero}'.`)
                                break;
                            
                            case "registrar nuevo pago":
                                window.location.replace("/pagos/registro/{{compra.pk}}/")
                                break;

                            // {% if pagos.count %}

                            case "descargar pdf":
                                hablar("Descargando reporte de pagos de la compra en formato PDF.");
                                reporte = true;
                                document.getElementById('pdf').click();
                                break;
                            
                            case "descargar mp3":
                                hablar("Descargando reporte de pagos de la compra en formato MP3.");
                                reporte = true;
                                document.getElementById('mp3').click();
                                break;
                            
                            case "descargar mp 3": 
                                hablar("Descargando reporte de pagos de la compra en formato MP3.");
                                reporte = true;
                                document.getElementById('mp3').click();
                                break;

                            // {% endif %}
                        }
                      }    
                   });

                   if(!speaking && (localStorage.getItem('comandos') == '0' || !localStorage.getItem('comandos')) && speech.toLowerCase().includes('activar comandos de voz')){
                        bienvenida();
                        localStorage.setItem("comandos", 1);
                        break;
                   }

                   if(dictando && speech.indexOf("dictado") == -1)
                        document.getElementById('busqueda').value += " " + speech.toLowerCase().replace(/.$/g, "");
                }
            }
        }

        var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;
        var recognition = new SpeechRecognition();
        recognition.lang = "es-VE";
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onresult = inicial;

        recognition.onerror = (event) => {
            if(event.error !== 'no-speech'){
                console.log(event);
            }
        }

        function bienvenida(){
            if ('speechSynthesis' in window) {
                let utterance = new SpeechSynthesisUtterance(`Justo ahora está en la pantalla de consulta de pagos para la compra {{compra.pk}} del inmueble {{compra.inmueble.nombre}}. Usted realizó {{pagos.count}} pagos para esta compra. 
                {% if compra.estado == 'X' %} Debido a que esta compra fue cancelada, los pagos fueron reembolsados.
                {% elif compra.estado == 'C' %} Debe esperar a que la compra sea cancelada para recibir su reembolso.
                {% else %} Usted ha cancelado {{compra.monto_cancelado_texto}} dólares de los {{compra.inmueble.precio_texto}} dólares del costo del inmueble. {% endif %}
                Diga "leer pago" seguido del número de pago para obtener una lectura del mismo. 
                {% if compra.estado == 'E' %}
                Diga "registrar nuevo pago" para ir al formulario de registro de pago.
                {% endif %}`);
                
                utterance.voice = voice;
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;
                utterance.onstart = () => {
                    speaking = true
                }
                utterance.onend = async (evt) => {
                    if(!speaking)
                        speaking = true
                    await new Promise(resolve => setTimeout(resolve, 500));
                    speaking = false, reporte = false;
                    console.log("LISTO");
                };
                synthesis.speak(utterance);
            }
        }

        function hablar(texto){
            if ('speechSynthesis' in window) {
                speaking = true;
                var utterance = new SpeechSynthesisUtterance(texto);
                utterance.voice = voice;
                utterance.pitch = 1;
                utterance.rate = 1;
                utterance.volume = 1;
                utterance.onstart = () => {
                    speaking = true
                }
                utterance.onend = async () => {speaking = false};
                synthesis.speak(utterance);
            }
        }
        
        window.onbeforeunload = function () {
            if(!reporte){
                synthesis.cancel();
                recognition.stop();
            }
        }
        
        if(localStorage.getItem('comandos') == '1')
            bienvenida();

        recognition.start();
        recognition.addEventListener('end', recognition.start);
    </script>
</head>
<body>
    <h2>Consultar Pagos Realizados</h2>
    {% if compra.estado == 'E' %}
    <a href="{% url 'formulario_registro_pago' pk=compra.pk %}">Registrar nuevo pago</a>
    {% endif %}

    {% if pagos.count %}
    <form method="post">
        {% csrf_token %}
        <button id="mp3" type="submit" name="tipo" value="mp3">DESCARGAR REPORTE MP3</button>
        <button id="pdf" type="submit" name="tipo" value="pdf">DESCARGAR REPORTE PDF</button>
    </form>
    {% else %}
    No hay pagos para esta compra.
    {% endif %}
    {% for pago in pagos %}
    <hr>
    <b>Monto</b>: Bs. {{pago.monto}} / $ {{pago.valor_dolar|floatformat:2}} (Tasa: {{pago.tasa.tasa}}) <br>
    <b>Estado:</b> {{pago.estado_largo}} <br>
    <b>Cuenta:</b> {{pago.cuenta}} <br>
    <b>Referencia:</b> {{pago.referencia}} <br>
    <b>Fecha:</b> {{pago.fecha}} <br>

    <b>Comentario:</b> {{pago.comentario}} <br>

    {% if pago.estado == 'R' %}
    <b>Comentario del Cajero: </b> {{pago.comentario_cajero}}
    {% endif %}
    {% empty %}
    No hay pagos.
    {% endfor %}
</body>
</html>